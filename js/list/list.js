define(["lib/backbone","lib/underscore","css!list/list.css"],function(Backbone,_){var List=Backbone.View.extend({events:{"click .list .search span":"goSearch","click .nav li ":"showType","click .go-top":"goTop"},tpl:_.template("<a href='<%=href%>'><img src='<%=src%>'></a>"),leftHeight:0,rightHeight:0,initialize:function(){var me=this;this.getdom(),this.listenTo(this.collection,"add",function(model){this.render(model)});var fn=_.throttle(function(){me.getdata()},2e3);$(window).on("scroll",function(){me.checkGoTop();var scale=($(window).scrollTop()+$(window).height())/$(document).height();scale>=.8&&fn()}),this.getdata(),this.checkGoTop()},checkGoTop:function(){$(window).scrollTop()>300?this.$el.find(".go-top").show():this.$el.find(".go-top").hide()},getdom:function(){this.leftDom=this.$el.find("image-left-container"),this.rightDom=this.$el.find("image-right-container")},getdata:function(){this.collection.fetchdata()},collectionFilter:function(val,key){return this.collection.filter(function(model){return"type"===key?model.get("type")==val:model.get("title").indexOf(val)>=0})},trim:function(val){return val.replace(/^\s+ | \s+$/g,"")},clearView:function(){this.$el.find(".image-left-container").html(""),this.$el.find(".image-right-container").html(""),this.leftHeight=0,this.rightHeight=0},clearInput:function(){this.$el.find(".list .search input").val("")},goSearch:function(){var val=this.getSearchVal(),check=this.checkSearchVal(),newVal=this.trim(val);if(check){var result=this.collectionFilter(newVal);if(0===result.length)return void alert("没有搜索到相关图片");this.clearView(),this.renderresult(result),this.clearInput()}},showType:function(e){var type=this.getTag(e),result=this.collectionFilter(type,"type");this.clearView(),this.renderresult(result)},goTop:function(){window.scrollTo(0,0)},renderresult:function(data){var me=this;data.forEach(function(model){me.render(model)})},render:function(model){var height=model.get("realheight"),data={href:"#layer/"+model.get("id"),src:model.get("url")};this.leftHeight<=this.rightHeight?this.renderLeft(data,height):this.renderRight(data,height)},renderLeft:function(data,height){var dom=this.$el.find(".image-left-container"),html=this.tpl(data);dom.append(html),this.leftHeight+=height},renderRight:function(data,height){var dom=this.$el.find(".image-right-container"),html=this.tpl(data);dom.append(html),this.rightHeight+=height},getSearchVal:function(){return this.$el.find(".search input").val()},getTag:function(e){return $(e.target).data("type")},checkSearchVal:function(val){return/^\s*$/.test(val)?(alert("请输入正确格式"),!1):!0}});return List});